<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/styles/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=icon  href="/assets/favicon.png"> <title>High HPET CPU Usage</title> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0550f3275b4a4db8bfeefed116695300"}'></script> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> </ul> </div> <div id=main > <div class=franklin-content > <h1 id=title ><a href="#title" class=header-anchor >High HPET CPU Usage</a></h1> <p>After I <a href="/posts/2022/12/28-build-swoole-cli-for-old-machines/">built swoole-cli</a>, I did&#39;t some benchmark to see how it performs.</p> <p>I tried <code>wrk</code> and <code>wrk2</code>, and found that <code>wrk2</code> performs much wrost than <code>wrk</code>.</p> <p>From <code>perf report</code>, <code>wrk2</code> spend over 60&#37; CPU time on <code>read_hpet</code>, while <code>wrk</code> use less than 20&#37;.</p> <p>wrk2:</p> <pre><code class="julia hljs">Overhead  Command  Shared Object     <span class=hljs-built_in >Symbol</span>
  <span class=hljs-number >64.43</span>%  wrk2     [kernel.vmlinux]  [k] read_hpet                                                                                                                                                                                                                  ◆
   <span class=hljs-number >2.53</span>%  wrk2     [vdso]            [.] __vdso_gettimeofday                                                                                                                                                                                                        ▒
   <span class=hljs-number >1.86</span>%  wrk2     [kernel.vmlinux]  [k] entry_SYSRETQ_unsafe_stack                                                                                                                                                                                                 ▒
   <span class=hljs-number >1.44</span>%  wrk2     [kernel.vmlinux]  [k] exit_to_user_mode_prepare                                                                                                                                                                                                  ▒
   <span class=hljs-number >0.85</span>%  wrk2     wrk2              [.] http_parser_execute                                                                                                                                                                                                        ▒
   <span class=hljs-number >0.80</span>%  wrk2     [kernel.vmlinux]  [k] entry_SYSCALL_64_after_hwframe                                                                                                                                                                                             ▒
   <span class=hljs-number >0.79</span>%  wrk2     wrk2              [.] aeProcessEvents.part<span class=hljs-number >.0</span>                                                                                                                                                                                                     ▒
   <span class=hljs-number >0.66</span>%  wrk2     [kernel.vmlinux]  [k] tcp_ack
   ...</code></pre> <p>wrk:</p> <pre><code class="julia hljs">Overhead  Command  Shared Object     <span class=hljs-built_in >Symbol</span>
  <span class=hljs-number >19.40</span>%  wrk      [kernel.vmlinux]  [k] read_hpet                                                                                                                                                                                                                  ◆
   <span class=hljs-number >3.14</span>%  wrk      wrk               [.] http_parser_execute                                                                                                                                                                                                        ▒
   <span class=hljs-number >2.19</span>%  wrk      [kernel.vmlinux]  [k] tcp_ack                                                                                                                                                                                                                    ▒
   <span class=hljs-number >1.71</span>%  wrk      [kernel.vmlinux]  [k] do_epoll_ctl                                                                                                                                                                                                               ▒
   <span class=hljs-number >1.35</span>%  wrk      [kernel.vmlinux]  [k] tcp_poll                                                                                                                                                                                                                   ▒
   <span class=hljs-number >1.35</span>%  wrk      [kernel.vmlinux]  [k] __fget_light                                                                                                                                                                                                               ▒
   <span class=hljs-number >1.27</span>%  wrk      [kernel.vmlinux]  [k] tcp_sendmsg_locked                                                                                                                                                                                                         ▒
   <span class=hljs-number >1.12</span>%  wrk      [kernel.vmlinux]  [k] __tcp_transmit_skb                                                                                                                                                                                                         ▒
   <span class=hljs-number >1.09</span>%  wrk      [kernel.vmlinux]  [k] sock_poll                                                                                                                                                                                                                  ▒
   <span class=hljs-number >1.01</span>%  wrk      [kernel.vmlinux]  [k] tcp_v4_rcv</code></pre> <h2 id=whats_hpet ><a href="#whats_hpet" class=header-anchor >What&#39;s HPET?</a></h2> <p>There are many great articles about HPET and TSC:</p> <ul> <li><p><a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter">Wikipedia: Time Stamp Counter</a></p> <li><p><a href="https://en.wikipedia.org/wiki/High_Precision_Event_Timer">Wikipedia: High Precision Event Timer</a></p> <li><p><a href="https://oliveryang.net/2015/09/pitfalls-of-TSC-usage/#32-software-tsc-usage-bugs">Pitfalls of TSC usage</a></p> <li><p><a href="https://deeperf.com/2019/04/30/tsc-clock-missing-caused-performance-issues/">A Performance Issue Caused by the TSC Clock Source Missing in Linux</a></p> </ul> <p>Basically, HPET clock is from a chip on the monitor, while TSC is from inside the CPU. So HPET is cost much more than TSC, and it&#39;s less accurate.</p> <h2 id=why_using_hept ><a href="#why_using_hept" class=header-anchor >Why using HEPT? </a></h2> <p>Let&#39;s see if my Pentium T4500 support TSC.</p> <p>From <code>lscpu</code>, it supports <code>tsc</code> and <code>constant_tsc</code>:</p> <pre><code class="julia hljs">Flags:                           fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good nopl cpuid aperfmperf pni dtes64 monitor ds_cpl est t
m2 ssse3 cx16 xtpr pdcm xsave lahf_lm dtherm</code></pre> <p>But kernel report that the system supports only <code>hpet</code> and <code>acpi_pm</code>:</p> <pre><code class="julia hljs">$ cat /sys/devices/system/clocksource/clocksource0/available_clocksource
hpet acpi_pm</code></pre> <p>Why? Because kernel found TSC skew is too large, and mark TSC as unstable:</p> <pre><code class="julia hljs">$ sudo dmesg | rg &#x27;tsc|clocksource&#x27;
[    <span class=hljs-number >0.000000</span>] tsc: Fast TSC calibration <span class=hljs-keyword >using</span> PIT
[    <span class=hljs-number >0.000000</span>] tsc: Detected <span class=hljs-number >2299.946</span> MHz processor
[    <span class=hljs-number >0.035079</span>] clocksource: refined-jiffies: mask: <span class=hljs-number >0xffffffff</span> max_cycles: <span class=hljs-number >0xffffffff</span>, max_idle_ns: <span class=hljs-number >6370452778343963</span> ns
[    <span class=hljs-number >0.091515</span>] clocksource: hpet: mask: <span class=hljs-number >0xffffffff</span> max_cycles: <span class=hljs-number >0xffffffff</span>, max_idle_ns: <span class=hljs-number >133484882848</span> ns
[    <span class=hljs-number >0.108205</span>] clocksource: tsc-early: mask: <span class=hljs-number >0xffffffffffffffff</span> max_cycles: <span class=hljs-number >0x21270226594</span>, max_idle_ns: <span class=hljs-number >440795254730</span> ns
[    <span class=hljs-number >0.254967</span>] clocksource: jiffies: mask: <span class=hljs-number >0xffffffff</span> max_cycles: <span class=hljs-number >0xffffffff</span>, max_idle_ns: <span class=hljs-number >6370867519511994</span> ns
[    <span class=hljs-number >0.344978</span>] clocksource: Switched to clocksource tsc-early
[    <span class=hljs-number >0.354941</span>] clocksource: acpi_pm: mask: <span class=hljs-number >0xffffff</span> max_cycles: <span class=hljs-number >0xffffff</span>, max_idle_ns: <span class=hljs-number >2085701024</span> ns
[    <span class=hljs-number >0.796814</span>] clocksource: timekeeping watchdog on CPU1: Marking clocksource &#x27;tsc-early&#x27; as unstable because the skew is too large:
[    <span class=hljs-number >0.796817</span>] clocksource:                       &#x27;hpet&#x27; wd_nsec: <span class=hljs-number >506655001</span> wd_now: f8d555 wd_last: <span class=hljs-number >8</span>a23ec mask: ffffffff
[    <span class=hljs-number >0.796820</span>] clocksource:                       &#x27;tsc-early&#x27; cs_nsec: <span class=hljs-number >205618777</span> cs_now: <span class=hljs-number >8</span>eec4900a cs_last: <span class=hljs-number >8</span>d2947f35 mask: ffffffffffffffff
[    <span class=hljs-number >0.796823</span>] clocksource:                       &#x27;tsc-early&#x27; is current clocksource.
[    <span class=hljs-number >0.796829</span>] tsc: Marking TSC unstable due to clocksource watchdog
[    <span class=hljs-number >0.796906</span>] TSC found unstable after boot, most likely due to broken BIOS. Use &#x27;tsc=unstable&#x27;.
[    <span class=hljs-number >0.797003</span>] clocksource: Switched to clocksource hpet</code></pre> <h2 id=maybe_i_can_use_tsc_directly ><a href="#maybe_i_can_use_tsc_directly" class=header-anchor >Maybe I can use TSC directly?</a></h2> <p>I tried to port <a href="https://github.com/MengRao/tscns">MengRao/tscns</a> to C, and plug it into wrk2.</p> <p>When I run the benchmark, wrk2 encounter negative latency value :&#40;</p> <p>So, kernel is correct, better not use TSC when it&#39;s not stable.</p> <div class=page-foot > Kauruus <br> <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> <br> Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> <script src="/libs/highlight/highlight.min.js"></script> <script>hljs.highlightAll();hljs.configure({tabReplace: ' '});</script>