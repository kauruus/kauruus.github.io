<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/styles/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=icon  href="/assets/favicon.png"> <title>Cross Compile Rust Program for mipsel</title> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0550f3275b4a4db8bfeefed116695300"}'></script> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> </ul> </div> <div id=main > <div class=franklin-content > <h1 id=title ><a href="#title" class=header-anchor >Cross Compile Rust Program for mipsel</a></h1> <p>Long time ago, I bought one <a href="https://openwrt.org/toh/xiaomi/miwifi_mini">Xiaomi Mi WiFi Mini</a> and installed OpenWrt on it. And I want to put some Rust program on it, so cross-compilation is needed.</p> <h2 id=chosing_a_toolchain ><a href="#chosing_a_toolchain" class=header-anchor >Chosing a Toolchain</a></h2> <p>To cross compile program for it, we first need a toolchain.</p> <p><a href="https://musl.cc/">musl.cc</a> provides static build of GCC toolchains.</p> <p>for mipsel, there are:</p> <ul> <li><p>mipsel-linux-musl-cross</p> <li><p>mipsel-linux-musln32-cross</p> <li><p>mipsel-linux-musln32sf-cross</p> <li><p>mipsel-linux-muslsf-cross</p> </ul> <p><code>sf</code> suffix means soft-float API. <code>n32</code> is for 64-bit kernel, but with 32-bit pointers. </p> <p>here&#39;s the <code>cat /proc/cpuinfo</code> output:</p> <pre><code class="julia hljs">system type             : MediaTek MT7620A ver:<span class=hljs-number >2</span> eco:<span class=hljs-number >6</span>
machine                 : Xiaomi MiWiFi Mini
processor               : <span class=hljs-number >0</span>
cpu model               : MIPS <span class=hljs-number >24</span>KEc V5<span class=hljs-number >.0</span>
BogoMIPS                : <span class=hljs-number >385.84</span>
wait instruction        : yes
microsecond timers      : yes
tlb_entries             : <span class=hljs-number >32</span>
extra interrupt vector  : yes
hardware watchpoint     : yes, count: <span class=hljs-number >4</span>, address/irw mask: [<span class=hljs-number >0x0ffc</span>, <span class=hljs-number >0x0ffc</span>, <span class=hljs-number >0x0ffb</span>, <span class=hljs-number >0x0ffb</span>]
<span class=hljs-keyword >isa</span>                     : mips1 mips2 mips32r1 mips32r2
ASEs implemented        : mips16 dsp
Options implemented     : tlb <span class=hljs-number >4</span>kex <span class=hljs-number >4</span>k_cache prefetch mcheck ejtag llsc pindexed_dcache userlo
cal vint perf_cntr_intr_bit perf
shadow register sets    : <span class=hljs-number >1</span>
kscratch registers      : <span class=hljs-number >0</span>
package                 : <span class=hljs-number >0</span>
core                    : <span class=hljs-number >0</span>
VCED exceptions         : not available
VCEI exceptions         : not available</code></pre> <p>seems it doesn&#39;t support FPU, so I am going to use the <code>sf</code> variant.</p> <h2 id=testing_the_toolchain ><a href="#testing_the_toolchain" class=header-anchor >Testing the Toolchain</a></h2> <p>let&#39;s build an hello world program in C.</p> <pre><code class="julia hljs">$ cat hello.c
<span class=hljs-comment >#include &lt;stdio.h&gt;</span>

int main() {
  printf(<span class=hljs-string >&quot;Hello, World!\n&quot;</span>);
}
$ mipsel-linux-muslsf-gcc hello.c -o hello
$ file hello
hello: ELF <span class=hljs-number >32</span>-bit LSB pie executable, MIPS, MIPS-I version <span class=hljs-number >1</span> (SYSV), dynamically linked, interpreter /lib/ld-musl-mipsel-sf.so<span class=hljs-number >.1</span>, not stripped</code></pre> <p>it works since the OpenWrt system has <code>/lib/ld-musl-mipsel-sf.so.1</code>:</p> <p>to static link it, add <code>-static</code></p> <pre><code class="julia hljs">$ mipsel-linux-muslsf-gcc hello.c -o hello -static
$ file hello
hello: ELF <span class=hljs-number >32</span>-bit LSB pie executable, MIPS, MIPS-I version <span class=hljs-number >1</span> (SYSV), static-pie linked, not stripped</code></pre> <p>it also works and the binary is quite small &#40;20KB&#41;.</p> <h1 id=cross_compile_rust_program ><a href="#cross_compile_rust_program" class=header-anchor >Cross Compile Rust program</a></h1> <p>First add a target:</p> <pre><code class="shell hljs"><span class="hljs-meta prompt_">$ </span><span class=language-bash >rustup target add mipsel-unknown-linux-musl</span></code></pre>
<p>in <code>~/.cargo/config</code>, set up the linker: </p>
<pre><code class="julia hljs">[target.mipsel-unknown-linux-musl]
linker = <span class=hljs-string >&quot;mipsel-linux-muslsf-gcc&quot;</span>
rustflags = [<span class=hljs-string >&quot;-Ctarget-feature=+crt-static&quot;</span>] <span class=hljs-comment ># static linked</span></code></pre>
<p>let&#39;s build a hello world program in Rust:</p>
<pre><code class="shell hljs"><span class="hljs-meta prompt_">$ </span><span class=language-bash >cargo new hello-world</span>
<span class="hljs-meta prompt_">$ </span><span class=language-bash ><span class=hljs-built_in >cd</span> hello-world</span>
<span class="hljs-meta prompt_">$ </span><span class=language-bash >cargo build --target mipsel-unknown-linux-musl --release</span>
<span class="hljs-meta prompt_">$ </span><span class=language-bash >file ./target/mipsel-unknown-linux-musl/release/hello-world</span>
./target/mipsel-unknown-linux-musl/release/hello-world: ELF 32-bit LSB executable, MIPS, MIPS32 rel2 version 1 (SYSV), statically linked, with debug_info, not stripped</code></pre>
<p>the binary is quite big &#40;4.9 MB&#41;. stripping the debug info can lower it to 572 KB, still quite big.</p>
<h1 id=dose_the_non_sf_variant_work ><a href="#dose_the_non_sf_variant_work" class=header-anchor >Dose the non <code>sf</code> variant work?</a></h1>
<p>I also try the non <code>sf</code> variant to see if it works. </p>
<pre><code class="shell hljs"><span class="hljs-meta prompt_">$ </span><span class=language-bash ><span class=hljs-built_in >cat</span> sin.c</span>
<span class="hljs-meta prompt_">#</span><span class=language-bash >include &lt;stdio.h&gt;</span>
<span class="hljs-meta prompt_">#</span><span class=language-bash >include &lt;math.h&gt;</span>

int main() {
  double x;
  scanf(&quot;%lf&quot;, &amp;x);
  printf(&quot;x = %f\n&quot;, x);
  printf(&quot;sin(x) = %f\n&quot;, sin(x));
}
<span class="hljs-meta prompt_">$ </span><span class=language-bash >mipsel-linux-musl-gcc -static -lm sin.c -o sin</span></code></pre>
<p>when run in OpenWrt:</p>
<pre><code class="julia hljs">$ ./sin
<span class=hljs-number >0.5</span>
Illegal instruction</code></pre>
<p>it doesn&#39;t work.</p>
<p>comparing the assembly, we can see the non-sf variant is using <code>lwc1</code> and <code>mfc1</code> instruction. these instructions are for moving float point numbers.</p>
<pre><code class="diff hljs"><span class=hljs-comment >--- sin.s       2023-10-09 12:37:41.045638697 +0800</span>
<span class=hljs-comment >+++ non-sf.s    2023-10-09 12:37:10.228019849 +0800</span>
<span class=hljs-meta >@@ -2,7 +2,7 @@</span>
        .section .mdebug.abi32
        .previous
        .nan    legacy
<span class=hljs-deletion >-       .module softfloat</span>
<span class=hljs-addition >+       .module fp=32</span>
        .module nooddspreg
        .abicalls
        .text
<span class=hljs-meta >@@ -48,8 +48,9 @@</span>
        nop

        lw      $28,16($fp)
<span class=hljs-deletion >-       lw      $2,24($fp)</span>
<span class=hljs-deletion >-       lw      $3,28($fp)</span>
<span class=hljs-addition >+       lwc1    $f0,24($fp)</span>
<span class=hljs-addition >+       nop</span>
<span class=hljs-addition >+       lwc1    $f1,28($fp)</span>
        lw      $6,24($fp)
        lw      $7,28($fp)
        lw      $2,%got($LC1)($28)
<span class=hljs-meta >@@ -63,10 +64,12 @@</span>
        nop

        lw      $28,16($fp)
<span class=hljs-deletion >-       lw      $2,24($fp)</span>
<span class=hljs-deletion >-       lw      $3,28($fp)</span>
<span class=hljs-deletion >-       lw      $4,24($fp)</span>
<span class=hljs-deletion >-       lw      $5,28($fp)</span>
<span class=hljs-addition >+       lwc1    $f0,24($fp)</span>
<span class=hljs-addition >+       nop</span>
<span class=hljs-addition >+       lwc1    $f1,28($fp)</span>
<span class=hljs-addition >+       lwc1    $f12,24($fp)</span>
<span class=hljs-addition >+       nop</span>
<span class=hljs-addition >+       lwc1    $f13,28($fp)</span>
        lw      $2,%call16(sin)($28)
        nop
        move    $25,$2
<span class=hljs-meta >@@ -75,8 +78,10 @@</span>
        nop

        lw      $28,16($fp)
<span class=hljs-deletion >-       move    $6,$2</span>
<span class=hljs-deletion >-       move    $7,$3</span>
<span class=hljs-addition >+       mfc1    $2,$f0</span>
<span class=hljs-addition >+       mfc1    $3,$f1</span>
<span class=hljs-addition >+       mfc1    $6,$f0</span>
<span class=hljs-addition >+       mfc1    $7,$f1</span>
        lw      $2,%got($LC2)($28)
        nop
        addiu   $4,$2,%lo($LC2)
<span class=hljs-meta >@@ -101,4 +106,3 @@</span>
        .end    main
        .size   main, .-main
        .ident  &quot;GCC: (GNU) 11.2.1 20211120&quot;
<span class=hljs-deletion >-       .section        .note.GNU-stack,&quot;&quot;,@progbits</span></code></pre>
<h2 id=does_the_rust_target_supports_fpu ><a href="#does_the_rust_target_supports_fpu" class=header-anchor >Does the Rust Target Supports FPU?</a></h2>
<p>Nope, the <code>mipsel-unknown-linux-musl</code> is <a href="https://github.com/rust-lang/rust/blob/1f48cbc3f8dbd393a7e713a0f90d7c6ec72d58ee/compiler/rustc_target/src/spec/mipsel_unknown_linux_musl.rs">hardcode to use soft-float</a>:</p>
<pre><code class="rust hljs"><span class=hljs-keyword >use</span> crate::spec::{Target, TargetOptions};

<span class=hljs-keyword >pub</span> <span class=hljs-keyword >fn</span> <span class="hljs-title function_">target</span>() <span class=hljs-punctuation >-&gt;</span> Target {
    <span class=hljs-keyword >let</span> <span class=hljs-keyword >mut </span><span class=hljs-variable >base</span> = super::linux_musl_base::<span class="hljs-title function_ invoke__">opts</span>();
    base.cpu = <span class=hljs-string >&quot;mips32r2&quot;</span>.<span class="hljs-title function_ invoke__">into</span>();
    base.features = <span class=hljs-string >&quot;+mips32r2,+soft-float&quot;</span>.<span class="hljs-title function_ invoke__">into</span>();
    base.max_atomic_width = <span class="hljs-title function_ invoke__">Some</span>(<span class=hljs-number >32</span>);
    base.crt_static_default = <span class=hljs-literal >false</span>;
    Target {
        llvm_target: <span class=hljs-string >&quot;mipsel-unknown-linux-musl&quot;</span>.<span class="hljs-title function_ invoke__">into</span>(),
        pointer_width: <span class=hljs-number >32</span>,
        data_layout: <span class=hljs-string >&quot;e-m:m-p:32:32-i8:8:32-i16:16:32-i64:64-n32-S64&quot;</span>.<span class="hljs-title function_ invoke__">into</span>(),
        arch: <span class=hljs-string >&quot;mips&quot;</span>.<span class="hljs-title function_ invoke__">into</span>(),
        options: TargetOptions { mcount: <span class=hljs-string >&quot;_mcount&quot;</span>.<span class="hljs-title function_ invoke__">into</span>(), ..base },
    }
}</code></pre>
<div class=page-foot >
    Kauruus <br>
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> <br>
    Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
</div>
</div>
        </div> 
    </div> 
    
    
        <script src="/libs/highlight/highlight.min.js"></script>
<script src="/libs/highlight/languages/lisp.min.js"></script>
<script src="/libs/highlight/languages/julia.min.js"></script>
<script>hljs.highlightAll();hljs.configure({tabReplace: '    '});</script>